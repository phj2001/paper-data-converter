# 纸质数据转换工具 V3.0 - 统一列结构版本

## 版本说明

V3.0 是完全重新设计的版本，专门用于处理**统一列结构**的批量图片识别。

### 核心特性

1. **运行前配置列结构** - 在处理图片前，必须确认列数和列标题
2. **严格格式验证** - 所有图片必须符合预定义的列结构
3. **单工作表输出** - 所有数据在同一个工作表中
4. **图片来源追踪** - 自动添加"图片名称"列标识数据来源

### 与V2.0的区别

| 特性 | V2.0 | V3.0 |
|------|------|------|
| 列结构 | 自动识别 | 用户预定义 |
| 工作表 | 按结构分组 | 单工作表 |
| 列标题 | 从图片识别 | 用户指定 |
| 适用场景 | 多种表格类型 | 统一格式表格 |

### 使用流程

#### 1. 运行程序
```bash
python main_v3.py
```

#### 2. 配置列结构

程序会提示输入：
```
请输入表格的总列数: 3

请为 3 列分别输入列标题:
第 1 列标题: 序号
第 2 列标题: 品名
第 3 列标题: 数量

配置确认
总列数: 3
列标题:
  1. 序号
  2. 品名
  3. 数量
确认以上配置正确? (y/n): y
```

#### 3. 自动处理

程序会自动处理 `images` 目录中的所有图片，并输出到 `output_data.xlsx`。

#### 4. 查看结果

Excel文件包含：
- 第1行：表头（用户定义的列标题 + "图片名称"）
- 第2行起：所有图片的数据，按顺序排列

### 输出格式示例

假设配置了3列：序号、品名、数量

| 序号 | 品名 | 数量 | 图片名称 |
|------|------|------|----------|
| 1 | 商品A | 100 | 001.jpg |
| 2 | 商品B | 200 | 001.jpg |
| 3 | 商品C | 150 | 002.jpg |
| ... | ... | ... | ... |

### 命令行参数

```bash
# 基本用法（交互式配置）
python main_v3.py

# 指定输入输出目录
python main_v3.py -i my_images -o result.xlsx

# 非交互模式（预定义列标题）
python main_v3.py --headers 序号 品名 数量 --no-interactive
```

### 错误处理

程序会自动处理以下情况：

1. **API超时** - 自动重试最多3次
2. **列数不匹配** - 显示错误并跳过该图片
3. **识别失败** - 记录到日志文件
4. **数据验证** - 确保所有行列数一致

### 日志文件

`conversion_log.txt` 记录完整的处理过程：
- 每张图片的处理状态
- 成功/失败原因
- 列数验证结果

### 常见问题

#### Q: 如何知道应该配置多少列？
A: 查看图片中的表格，统计主数据列的数量（不包括序号列等额外列）。

#### Q: 列标题必须和图片中完全一致吗？
A: 不需要。列标题是你期望的输出格式，程序会按照你的要求重新组织数据。

#### Q: 某些图片识别失败了怎么办？
A: 查看 `conversion_log.txt` 了解失败原因。如果是个别图片失败，可以：
1. 重新扫描或拍照，提高图片质量
2. 确认图片确实包含符合格式的表格
3. 手动补充缺失的数据

#### Q: 可以修改已配置的列结构吗？
A: 运行程序时选择 'n' 重新配置，或使用 `--headers` 参数直接指定。

### 最佳实践

1. **统一图片质量** - 确保所有图片清晰度、角度一致
2. **统一表格格式** - 所有图片应该包含相同结构的表格
3. **合理的列标题** - 使用简洁明确的列标题
4. **批量处理前测试** - 先用1-2张图片测试配置是否正确

### 技术架构

```
main_v3.py          # 主程序入口
├── get_column_config_from_user()  # 交互式配置
├── UnifiedConverter               # 转换器
│   ├── _process_single_image()    # 处理单张图片
│   └── convert()                  # 批量转换
└── ExcelWriter                    # Excel写入器
    ├── add_data()                 # 添加数据
    └── save()                     # 保存文件

ocr_processor.py
└── process_image_with_headers()   # 使用预定义列标题识别
```

### 版本历史

- **V3.0** (2026-01-07) - 统一列结构版本
  - 交互式列配置
  - 单工作表输出
  - 严格的格式验证

- **V2.0** (2026-01-07) - 智能分组版本
  - 自动识别表格结构
  - 按结构分组输出
  - 多工作表支持

- **V1.0** - 初始版本
  - 基础OCR识别
  - 简单CSV输出
